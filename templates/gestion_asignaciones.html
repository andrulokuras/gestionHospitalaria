<!-- Parte de la estructura de la vista, como los formularios, la plantilla de tablas,
     el modal de edición, las validaciones front-end y la integración con la lógica del servidor,
     fue generada y asistida mediante ChatGPT (OpenAI, versión GPT-5.1).
     La interfaz fue adaptada y personalizada por el estudiante para cumplir con las necesidades
     del sistema, la experiencia de usuario y los requerimientos visuales del proyecto. -->

{% extends "base.html" %}

{% block title %}Gestión de Asignaciones y Turnos{% endblock %}

{% block content %}
    <h1>Asignación de Turnos y Personal a Áreas</h1>

    <!-- MENSAJE CAMPOS OBLIGATORIOS -->
    <div class="alert alert-info">
        Por favor llena todos los campos obligatorios marcados con (<span class="text-danger">*</span>).
        La descripción de la asignación es <strong>opcional</strong>.
    </div>

    <!-- MENSAJE DE ERROR -->
    <div id="errorCamposObligatorios" class="alert alert-danger d-none">
        Por favor llenar todos los campos obligatorios.
    </div>

    <div class="card shadow-sm mb-5">
        <div class="card-header bg-primary text-white">
            Registrar Nueva Asignación de Turno
        </div>
        <div class="card-body">
            <form id="formCrearAsignacion" action="{{ url_for('gestion_asignaciones') }}" method="POST" novalidate>
                <input type="hidden" name="create_asignacion" value="1">
                <div class="row g-3">
                    
                    <!-- ÁREA con datalist -->
                    <div class="col-md-3">
                        <label for="id_area_fk" class="form-label">
                            Área (ID / Nombre) <span class="text-danger">*</span>
                        </label>
                        <input type="text"
                               class="form-control"
                               id="id_area_fk"
                               name="id_area_fk"
                               list="listaAreasAsign"
                               placeholder="Ej: 5 - UCI Adultos"
                               data-required="true">
                        <div class="form-text">Escribe el ID o el nombre del área y selecciona de la lista.</div>
                    </div>

                    <!-- EMPLEADO con datalist -->
                    <div class="col-md-3">
                        <label for="id_empleado_fk" class="form-label">
                            Empleado (ID / Nombre) <span class="text-danger">*</span>
                        </label>
                        <input type="text"
                               class="form-control"
                               id="id_empleado_fk"
                               name="id_empleado_fk"
                               list="listaEmpleadosAsign"
                               placeholder="Ej: 102 - Juan Pérez"
                               data-required="true">
                        <div class="form-text">Escribe el ID o el nombre y selecciona de la lista.</div>
                    </div>

                    <div class="col-md-3">
                        <label for="turno_datetime" class="form-label">
                            Fecha y Hora del Turno <span class="text-danger">*</span>
                        </label>
                        <input type="datetime-local" class="form-control" id="turno_datetime"
                               name="turno_datetime" data-required="true">
                    </div>
                </div>

                <div class="row g-3 mt-3">
                    <div class="col-12">
                        <label for="asignacion" class="form-label">
                            Descripción de la Asignación (opcional)
                        </label>
                        <textarea class="form-control" id="asignacion" name="asignacion" rows="2"
                                  placeholder="Ej: Rotación obligatoria en UCI, Apoyo quirúrgico, Tareas administrativas de cierre."></textarea>
                    </div>
                </div>

                <div class="mt-4 text-end">
                    <button type="submit" class="btn btn-success">Registrar Asignación</button>
                </div>
            </form>
        </div>
    </div>
    
    <h2>Turnos y Asignaciones Registradas</h2>

    <form method="get" class="row g-3 mb-3">
        <div class="col-md-8">
            <label class="form-label">Filtrar por nombre de médico / empleado</label>
            <input
                type="text"
                name="buscar_medico"
                class="form-control"
                placeholder="Ej. Juan Pérez, Ana López"
                value="{{ filtro_nombre_medico or '' }}"
            >
        </div>
        <div class="col-md-4 d-flex align-items-end">
            <button type="submit" class="btn btn-secondary w-100">Filtrar</button>
        </div>
    </form>

    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th scope="col">ID</th>
                    <th scope="col">Empleado</th>
                    <th scope="col">Área Asignada</th>
                    <th scope="col">Turno (Fecha/Hora)</th>
                    <th scope="col">Descripción de Asignación</th>
                    <th scope="col">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for asignacion in asignaciones %}
                <tr>
                    <th scope="row">{{ asignacion.id_asignacion }}</th>
                    <td>
                        <span class="badge bg-secondary">{{ asignacion.id_empleado }}</span>
                        {{ asignacion.nombre_empleado }}
                    </td>
                    <td>
                        <span class="badge bg-info">{{ asignacion.id_area_especifica }}</span>
                        {{ asignacion.nombre_area }}
                    </td>
                    <td>{{ asignacion.turno_datetime }}</td>
                    <td>{{ asignacion.asignacion or '—' }}</td>
                    <td>
                        <div class="btn-group">
                            <button type="button" class="btn btn-sm btn-warning"
                                    data-bs-toggle="modal" data-bs-target="#modalEditar{{ asignacion.id_asignacion }}">
                                Editar
                            </button>
                            <button type="button" class="btn btn-sm btn-danger"
                                    data-bs-toggle="modal" data-bs-target="#modalEliminar{{ asignacion.id_asignacion }}">
                                Eliminar
                            </button>
                        </div>
                    </td>
                </tr>
                
                <!-- MODAL EDITAR -->
                <div class="modal fade" id="modalEditar{{ asignacion.id_asignacion }}" tabindex="-1"
                     aria-labelledby="modalEditarLabel{{ asignacion.id_asignacion }}" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-warning text-white">
                                <h5 class="modal-title" id="modalEditarLabel{{ asignacion.id_asignacion }}">
                                    Editar Asignación ID: {{ asignacion.id_asignacion }}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <form class="formEditAsignacion" action="{{ url_for('gestion_asignaciones') }}" method="POST" novalidate>
                                <div class="modal-body">
                                    <input type="hidden" name="update_asignacion" value="1">
                                    <input type="hidden" name="id_asignacion_actualizar" value="{{ asignacion.id_asignacion }}">

                                    <div class="row g-3 mb-3">
                                        <!-- EMPLEADO con datalist -->
                                        <div class="col-md-6">
                                            <label for="id_empleado_edit_{{ asignacion.id_asignacion }}" class="form-label">
                                                Empleado Asignado (ID / Nombre) <span class="text-danger">*</span>
                                            </label>
                                            <input type="text"
                                                   class="form-control"
                                                   id="id_empleado_edit_{{ asignacion.id_asignacion }}"
                                                   name="id_empleado_edit"
                                                   list="listaEmpleadosAsign"
                                                   value="{{ asignacion.id_empleado }} - {{ asignacion.nombre_empleado }}"
                                                   data-required="true">
                                        </div>
                                        
                                        <!-- ÁREA con datalist -->
                                        <div class="col-md-6">
                                            <label for="id_area_especifica_edit_{{ asignacion.id_asignacion }}" class="form-label">
                                                Área Específica (ID / Nombre) <span class="text-danger">*</span>
                                            </label>
                                            <input type="text"
                                                   class="form-control"
                                                   id="id_area_especifica_edit_{{ asignacion.id_asignacion }}"
                                                   name="id_area_especifica_edit"
                                                   list="listaAreasAsign"
                                                   value="{{ asignacion.id_area_especifica }} - {{ asignacion.nombre_area }}"
                                                   data-required="true">
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="turno_datetime_edit_{{ asignacion.id_asignacion }}" class="form-label">
                                            Fecha y Hora del Turno <span class="text-danger">*</span>
                                        </label>
                                        {% set current_datetime = asignacion.turno_datetime.strftime('%Y-%m-%dT%H:%M') if asignacion.turno_datetime.isoformat is defined else asignacion.turno_datetime %}
                                        <input type="datetime-local" class="form-control"
                                               id="turno_datetime_edit_{{ asignacion.id_asignacion }}"
                                               name="turno_datetime_edit"
                                               value="{{ current_datetime }}" data-required="true">
                                    </div>

                                    <div class="mb-3">
                                        <label for="asignacion_edit_{{ asignacion.id_asignacion }}" class="form-label">
                                            Descripción de la Asignación (opcional)
                                        </label>
                                        <textarea class="form-control"
                                                  id="asignacion_edit_{{ asignacion.id_asignacion }}"
                                                  name="asignacion_edit" rows="3">{{ asignacion.asignacion or '' }}</textarea>
                                    </div>

                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                    <button type="submit" class="btn btn-warning">Guardar Cambios</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- MODAL ELIMINAR -->
                <div class="modal fade" id="modalEliminar{{ asignacion.id_asignacion }}" tabindex="-1"
                     aria-labelledby="modalEliminarLabel{{ asignacion.id_asignacion }}" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form action="{{ url_for('gestion_asignaciones') }}" method="POST">
                                <input type="hidden" name="delete_asignacion" value="1">
                                <input type="hidden" name="id_asignacion_eliminar" value="{{ asignacion.id_asignacion }}">

                                <div class="modal-header bg-danger text-white">
                                    <h5 class="modal-title" id="modalEliminarLabel{{ asignacion.id_asignacion }}">
                                        Confirmar Eliminación
                                    </h5>
                                    <button class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <p>¿Estás seguro de que quieres eliminar la siguiente asignación de turno?</p>
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item"><strong>ID Asignación:</strong> {{ asignacion.id_asignacion }}</li>
                                        <li class="list-group-item"><strong>Empleado:</strong> {{ asignacion.nombre_empleado }}</li>
                                        <li class="list-group-item"><strong>Turno:</strong> {{ asignacion.turno_datetime }}</li>
                                    </ul>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                    <button type="submit" class="btn btn-danger">Eliminar Definitivamente</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if not asignaciones %}
        <div class="alert alert-info mt-3">No hay asignaciones de turnos registradas aún.</div>
    {% endif %}

    <!-- DATALISTS REUTILIZABLES PARA AREA Y EMPLEADO -->
    <datalist id="listaEmpleadosAsign">
      {% for empleado in empleados %}
        <option value="{{ empleado.id_empleado }} - {{ empleado.nombre }}"></option>
      {% endfor %}
    </datalist>

    <datalist id="listaAreasAsign">
      {% for area in areas %}
        <option value="{{ area.id_area_especifica }} - {{ area.nombre }}"></option>
      {% endfor %}
    </datalist>
    
    <!-- VALIDACIÓN CAMPOS OBLIGATORIOS -->
    <script>
    const formsAsignaciones = document.querySelectorAll("#formCrearAsignacion, form.formEditAsignacion");

    formsAsignaciones.forEach(form => {
        form.addEventListener("submit", function(e) {
            let valido = true;
            const obligatorios = form.querySelectorAll("[data-required='true']");
            const errorMsg = document.getElementById("errorCamposObligatorios");

            if (errorMsg) errorMsg.classList.add("d-none");

            obligatorios.forEach(campo => {
                campo.classList.remove("is-invalid");
                if (!campo.value || !campo.value.toString().trim()) {
                    valido = false;
                    campo.classList.add("is-invalid");
                }
            });

            if (!valido) {
                e.preventDefault();
                if (errorMsg) errorMsg.classList.remove("d-none");
            }
        });
    });
    </script>

{% endblock %}

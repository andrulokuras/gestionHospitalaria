{% extends "base.html" %}

{% block title %}Gestión de Personal{% endblock %}

{% block content %}
<h2 class="mb-4">Administración de Médicos y Personal</h2>

<div class="card mb-4">
    <div class="card-header">
        Crear Nuevo Empleado (ID Automático)
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('gestion_empleados') }}">
            <input type="hidden" name="create" value="1">
            <div class="row g-3 align-items-end">
                
                <div class="col-md-4">
                    <label class="form-label">Nombre Completo</label>
                    <input type="text" name="nombre" class="form-control" placeholder="Nombre" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Puesto/Especialidad</label>
                    <input type="text" name="puesto" class="form-control" placeholder="Ej: Médico Cirujano" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Fecha Contratación</label>
                    <input type="date" name="fecha_contratacion" class="form-control" required>
                </div>
                <div class="col-md-2 d-grid">
                    <button type="submit" class="btn btn-primary"> Guardar Empleado</button>
                </div>
            </div>
        </form>
    </div>
</div>

<h3 class="mt-5 mb-3">Lista de Empleados</h3>
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Puesto</th>
                <th>Fecha Contrato</th>
                <th>Acciones</th> </tr>
        </thead>
        <tbody>
            {% for emp in empleados %}
            <tr>
                <td>{{ emp.id_empleado }}</td>
                <td>{{ emp.nombre }}</td>
                <td>{{ emp.puesto_especialidad }}</td>
                <td>{{ emp.fecha_contratacion }}</td>
                <td>
                    <button class="btn btn-sm btn-warning"
                            data-bs-toggle="modal"
                            data-bs-target="#editModal"
                            data-id="{{ emp.id_empleado }}"
                            data-nombre="{{ emp.nombre }}"
                            data-puesto="{{ emp.puesto_especialidad }}"
                            data-fecha="{{ emp.fecha_contratacion }}">
                        Editar
                    </button>

                    <form method="POST" style="display:inline;" onsubmit="return confirm('¿Está seguro de eliminar a {{ emp.nombre }}? Esta acción es irreversible.');">
                        <input type="hidden" name="delete" value="1">
                        <input type="hidden" name="id_empleado_eliminar" value="{{ emp.id_empleado }}">
                        <button type="submit" class="btn btn-sm btn-danger">Eliminar</button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="5" class="text-center">No hay empleados registrados.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Editar Empleado</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('gestion_empleados') }}">
                <div class="modal-body">
                    <input type="hidden" name="update" value="1">
                    <input type="hidden" name="id_empleado_actualizar" id="id_empleado_actualizar">

                    <div class="mb-3">
                        <label for="nombre_edit" class="form-label">Nombre Completo</label>
                        <input type="text" class="form-control" id="nombre_edit" name="nombre_edit" required>
                    </div>
                    <div class="mb-3">
                        <label for="puesto_edit" class="form-label">Puesto/Especialidad</label>
                        <input type="text" class="form-control" id="puesto_edit" name="puesto_edit" required>
                    </div>
                    <div class="mb-3">
                        <label for="fecha_contratacion_edit" class="form-label">Fecha Contratación</label>
                        <input type="date" class="form-control" id="fecha_contratacion_edit" name="fecha_contratacion_edit" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="submit" class="btn btn-warning">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    var editModal = document.getElementById('editModal')
    
    editModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget

        // Extrae los datos del empleado almacenados en los atributos 'data-' del botón
        var id = button.getAttribute('data-id')
        var nombre = button.getAttribute('data-nombre')
        var puesto = button.getAttribute('data-puesto')
        var fecha = button.getAttribute('data-fecha') 

        // Rellena los campos del formulario dentro del modal
        editModal.querySelector('#id_empleado_actualizar').value = id
        editModal.querySelector('#nombre_edit').value = nombre
        editModal.querySelector('#puesto_edit').value = puesto
        editModal.querySelector('#fecha_contratacion_edit').value = fecha
    })
</script>

{% endblock %}
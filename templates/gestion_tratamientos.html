{% extends "base.html" %}

{% block title %}Gestión de Tratamientos{% endblock %}

{% block content %}
<h2 class="mb-4">Registro y Gestión de Tratamientos</h2>

<!-- MENSAJE CAMPOS OBLIGATORIOS -->
<div class="alert alert-info">
  Por favor llena todos los campos obligatorios marcados con (<span class="text-danger">*</span>).
</div>

<!-- Error al validar -->
<div id="errorCamposObligatorios" class="alert alert-danger d-none">
  Por favor llenar todos los campos obligatorios.
</div>

<!-- Card: Registrar nuevo tratamiento -->
<div class="card mb-4">
  <div class="card-header">
    Registrar Nuevo Tratamiento
  </div>
  <div class="card-body">
    <form id="formCrearTratamiento" method="POST" action="{{ url_for('gestion_tratamientos') }}" novalidate>
      <input type="hidden" name="create_tratamiento" value="1">
      <div class="row g-3">

        <!-- ID Paciente -->
        <div class="col-md-2">
          <label for="id_paciente" class="form-label">ID Paciente <span class="text-danger">*</span></label>
          <input type="number" id="id_paciente" name="id_paciente"
                 class="form-control" data-required="true">
        </div>

        <!-- Tipo -->
        <div class="col-md-3">
          <label for="tipo" class="form-label">Tipo de Tratamiento <span class="text-danger">*</span></label>
          <select id="tipo" name="tipo" class="form-select" data-required="true">
            <option value="" selected disabled>Selecciona...</option>
            <option value="Quirúrgico">Quirúrgico</option>
            <option value="Farmacológico">Farmacológico</option>
            <option value="Terapéutico">Terapéutico</option>
          </select>
        </div>

        <!-- Fecha inicio -->
        <div class="col-md-3">
          <label for="fecha_inicio" class="form-label">Fecha de Inicio <span class="text-danger">*</span></label>
          <input type="date" id="fecha_inicio" name="fecha_inicio"
                 class="form-control" data-required="true">
        </div>

        <!-- Estado actual -->
        <div class="col-md-4">
          <label for="estado_actual" class="form-label">Estado Actual <span class="text-danger">*</span></label>
          <input type="text" id="estado_actual" name="estado_actual"
                 class="form-control"
                 placeholder="En curso, finalizado, suspendido..."
                 data-required="true">
        </div>

        <!-- Área -->
        <div class="col-md-3">
          <label for="id_area_especifica" class="form-label">ID Área <span class="text-danger">*</span></label>
          <input type="number" id="id_area_especifica" name="id_area_especifica"
                 class="form-control" data-required="true">
        </div>

        <!-- Procedimiento opcional -->
        <div class="col-md-3">
          <label for="id_procedimiento" class="form-label">ID Procedimiento (opcional)</label>
          <input type="number" id="id_procedimiento" name="id_procedimiento"
                 class="form-control">
        </div>

        <div class="col-12 d-grid">
          <button type="submit" class="btn btn-primary">Registrar Tratamiento</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Tabla de tratamientos -->
<div class="card">
  <div class="card-header">
    Tratamientos Registrados
  </div>
  <div class="card-body table-responsive">
        <!-- Filtro por nombre de paciente -->
    <form method="GET" action="{{ url_for('gestion_tratamientos') }}" class="row g-2 mb-3">
      <div class="col-md-8">
        <label class="form-label">Buscar por nombre de paciente</label>
        <input
          type="text"
          name="buscar_paciente"
          class="form-control"
          placeholder="Ej. Juan Pérez"
          value="{{ filtro_nombre or '' }}"
        >
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button type="submit" class="btn btn-secondary w-100">
          Buscar
        </button>
      </div>
    </form>

    <table class="table table-striped table-hover">
      <thead>
      ...

    <table class="table table-striped table-hover">
      <thead>
        <tr>
          <th>ID</th>
          <th>Paciente (ID - Nombre)</th>
          <th>Tipo</th>
          <th>Fecha Inicio</th>
          <th>Estado</th>
          <th>Área (ID - Nombre)</th>
          <th>ID Procedimiento</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for t in tratamientos %}
        <tr>
          <td>{{ t.id_tratamiento }}</td>
          <td>
            {{ t.id_paciente }}
            {% if t.nombre_paciente %}- {{ t.nombre_paciente }}{% endif %}
          </td>
          <td>{{ t.tipo }}</td>
          <td>{{ t.fecha_inicio }}</td>
          <td>{{ t.estado_actual }}</td>
          <td>
            {{ t.id_area_especifica }}
            {% if t.nombre_area %}- {{ t.nombre_area }}{% endif %}
          </td>
          <td>
            {% if t.id_procedimiento %}
              {{ t.id_procedimiento }}
            {% else %}
              -
            {% endif %}
          </td>
          <td>
            <!-- Botón editar -->
            <button class="btn btn-sm btn-warning" data-bs-toggle="modal"
                    data-bs-target="#modalEditar{{ t.id_tratamiento }}">
              Editar
            </button>
            <!-- Botón eliminar -->
            <button class="btn btn-sm btn-danger" data-bs-toggle="modal"
                    data-bs-target="#modalEliminar{{ t.id_tratamiento }}">
              Eliminar
            </button>
          </td>
        </tr>

        <!-- Modal Editar -->
        <div class="modal fade" id="modalEditar{{ t.id_tratamiento }}" tabindex="-1"
             aria-labelledby="modalEditarLabel{{ t.id_tratamiento }}" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <form method="POST" action="{{ url_for('gestion_tratamientos') }}"
                    class="form-editar-tratamiento" novalidate>
                <input type="hidden" name="update_tratamiento" value="1">
                <input type="hidden" name="id_tratamiento_actualizar" value="{{ t.id_tratamiento }}">
                <div class="modal-header">
                  <h5 class="modal-title" id="modalEditarLabel{{ t.id_tratamiento }}">Editar Tratamiento</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">

                  <div class="mb-3">
                    <label class="form-label">ID Paciente <span class="text-danger">*</span></label>
                    <input type="number" name="id_paciente_edit" class="form-control"
                           value="{{ t.id_paciente }}" data-required="true">
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Tipo <span class="text-danger">*</span></label>
                    <select name="tipo_edit" class="form-select" data-required="true">
                      <option value="Quirúrgico"   {% if t.tipo == 'Quirúrgico' %}selected{% endif %}>Quirúrgico</option>
                      <option value="Farmacológico" {% if t.tipo == 'Farmacológico' %}selected{% endif %}>Farmacológico</option>
                      <option value="Terapéutico"   {% if t.tipo == 'Terapéutico' %}selected{% endif %}>Terapéutico</option>
                    </select>
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Fecha de Inicio <span class="text-danger">*</span></label>
                    <input type="date" name="fecha_inicio_edit" class="form-control"
                           value="{{ t.fecha_inicio }}" data-required="true">
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Estado Actual <span class="text-danger">*</span></label>
                    <input type="text" name="estado_actual_edit" class="form-control"
                           value="{{ t.estado_actual }}" data-required="true">
                  </div>

                  <div class="mb-3">
                    <label class="form-label">ID Área <span class="text-danger">*</span></label>
                    <input type="number" name="id_area_especifica_edit" class="form-control"
                           value="{{ t.id_area_especifica }}" data-required="true">
                  </div>

                  <div class="mb-3">
                    <label class="form-label">ID Procedimiento (opcional)</label>
                    <input type="number" name="id_procedimiento_edit" class="form-control"
                           value="{{ t.id_procedimiento }}">
                  </div>

                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                  <button type="submit" class="btn btn-primary">Guardar cambios</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Modal Eliminar -->
        <div class="modal fade" id="modalEliminar{{ t.id_tratamiento }}" tabindex="-1"
             aria-labelledby="modalEliminarLabel{{ t.id_tratamiento }}" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <form method="POST" action="{{ url_for('gestion_tratamientos') }}">
                <input type="hidden" name="delete_tratamiento" value="1">
                <input type="hidden" name="id_tratamiento_eliminar" value="{{ t.id_tratamiento }}">
                <div class="modal-header">
                  <h5 class="modal-title" id="modalEliminarLabel{{ t.id_tratamiento }}">Confirmar eliminación</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  ¿Seguro que deseas eliminar el tratamiento ID {{ t.id_tratamiento }}?
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                  <button type="submit" class="btn btn-danger">Eliminar</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- VALIDACIÓN JS -->
<script>
const formsTrat = document.querySelectorAll("#formCrearTratamiento, form.form-editar-tratamiento");

formsTrat.forEach(form => {
  form.addEventListener("submit", function (e) {
    let valido = true;
    const obligatorios = form.querySelectorAll("[data-required='true']");
    const errorMsg = document.getElementById("errorCamposObligatorios");

    if (errorMsg) errorMsg.classList.add("d-none");

    obligatorios.forEach(campo => {
      campo.classList.remove("is-invalid");
      if (!campo.value || !campo.value.toString().trim()) {
        valido = false;
        campo.classList.add("is-invalid");
      }
    });

    if (!valido) {
      e.preventDefault();
      if (errorMsg) errorMsg.classList.remove("d-none");
    }
  });
});
</script>

{% endblock %}

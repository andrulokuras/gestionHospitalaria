{% extends "base.html" %}

{% block title %}Gestión de Participaciones{% endblock %}

{% block content %}
<h2 class="mb-4">Registro y Gestión de Participaciones</h2>

<!-- MENSAJE CAMPOS OBLIGATORIOS -->
<div class="alert alert-info">
    Por favor llena todos los campos obligatorios marcados con (<span class="text-danger">*</span>).
</div>

<!-- MENSAJE ERROR -->
<div id="errorCamposObligatorios" class="alert alert-danger d-none">
    Por favor llenar todos los campos obligatorios.
</div>

<div class="card mb-4">
  <div class="card-header">
    Registrar Nueva Participación
  </div>
  <div class="card-body">
    <form id="formCrearParticipacion" method="POST" action="{{ url_for('gestion_participaciones') }}" novalidate>
      <input type="hidden" name="create_participacion" value="1">

      <div class="row g-3">

        <div class="col-md-3">
          <label class="form-label">Tipo de Intervención <span class="text-danger">*</span></label>
          <select name="tipo_intervencion" class="form-select" data-required="true">
            <option value="" selected disabled>Selecciona...</option>
            <option value="Consulta">Consulta</option>
            <option value="Cirugía">Cirugía</option>
            <option value="Seguimiento">Seguimiento</option>
            <option value="Terapia">Terapia</option>
            <option value="Administrativa">Administrativa</option>
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Fecha <span class="text-danger">*</span></label>
          <input type="date" name="fecha" class="form-control" data-required="true">
        </div>

        <div class="col-md-3">
          <label class="form-label">Rol <span class="text-danger">*</span></label>
          <input type="text" name="rol" class="form-control" placeholder="Médico, Enfermera, Asistente..."
                 data-required="true">
        </div>

        <div class="col-md-2">
          <label class="form-label">ID Tratamiento <span class="text-danger">*</span></label>
          <input type="number" name="id_tratamiento" class="form-control" data-required="true">
        </div>

        <div class="col-md-1">
          <label class="form-label">ID Empleado <span class="text-danger">*</span></label>
          <input type="number" name="id_empleado" class="form-control" data-required="true">
        </div>

        <div class="col-12 d-grid">
          <button type="submit" class="btn btn-primary">Registrar Participación</button>
        </div>

      </div>
    </form>
  </div>
</div>

<div class="card">
  <div class="card-header">
    Participaciones Registradas
  </div>
  <div class="card-body">

    <form method="get" class="row g-3 mb-3">
      <div class="col-md-4">
        <label class="form-label">Filtrar por Tipo de Intervención</label>
        <select name="buscar_tipo_intervencion" class="form-select">
          <option value="">Todas</option>
          <option value="Consulta"       {% if filtro_tipo_intervencion == 'Consulta' %}selected{% endif %}>Consulta</option>
          <option value="Cirugía"        {% if filtro_tipo_intervencion == 'Cirugía' %}selected{% endif %}>Cirugía</option>
          <option value="Seguimiento"    {% if filtro_tipo_intervencion == 'Seguimiento' %}selected{% endif %}>Seguimiento</option>
          <option value="Terapia"        {% if filtro_tipo_intervencion == 'Terapia' %}selected{% endif %}>Terapia</option>
          <option value="Administrativa" {% if filtro_tipo_intervencion == 'Administrativa' %}selected{% endif %}>Administrativa</option>
        </select>
      </div>

      <div class="col-md-5">
        <label class="form-label">Filtrar por nombre de empleado</label>
        <input
          type="text"
          name="buscar_empleado"
          class="form-control"
          placeholder="Ej. Juan Pérez"
          value="{{ filtro_nombre_empleado or '' }}"
        >
      </div>

      <div class="col-md-3 d-flex align-items-end">
        <button type="submit" class="btn btn-secondary w-100">Filtrar</button>
      </div>
    </form>

    <div class="table-responsive">
      <table class="table table-striped table-hover">

    <table class="table table-striped table-hover">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>Tipo Intervención</th>
          <th>Fecha</th>
          <th>Rol</th>
          <th>Tratamiento / Paciente</th>
          <th>Empleado (ID - Nombre)</th>
          <th>Acciones</th>
        </tr>
      </thead>

      <tbody>
        {% for p in participaciones %}
        <tr>
          <td>{{ p.id_participacion }}</td>
          <td>{{ p.tipo_intervencion }}</td>
          <td>{{ p.fecha }}</td>
          <td>{{ p.rol }}</td>
          <td>
            {% if p.tipo_tratamiento or p.nombre_paciente %}
              {{ p.tipo_tratamiento or 'Tratamiento sin tipo' }} 
              - 
              {{ p.nombre_paciente or 'Paciente sin nombre' }}
            {% else %}
              {{ p.id_tratamiento }}
            {% endif %}
          </td>
          <td>
            {{ p.id_empleado }}
            {% if p.nombre_empleado %}- {{ p.nombre_empleado }}{% endif %}
          </td>
          <td>
            <button class="btn btn-sm btn-warning" data-bs-toggle="modal"
                    data-bs-target="#modalEditar{{ p.id_participacion }}">
              Editar
            </button>
            <button class="btn btn-sm btn-danger" data-bs-toggle="modal"
                    data-bs-target="#modalEliminar{{ p.id_participacion }}">
              Eliminar
            </button>
          </td>
        </tr>

        <!-- MODAL EDITAR -->
        <div class="modal fade" id="modalEditar{{ p.id_participacion }}" tabindex="-1"
             aria-labelledby="modalEditarLabel{{ p.id_participacion }}" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">

              <form class="formEditarParticipacion" method="POST" action="{{ url_for('gestion_participaciones') }}" novalidate>
                <input type="hidden" name="update_participacion" value="1">
                <input type="hidden" name="id_participacion_actualizar" value="{{ p.id_participacion }}">

                <div class="modal-header">
                  <h5 class="modal-title">Editar Participación</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">

                  <div class="mb-3">
                    <label class="form-label">Tipo de Intervención <span class="text-danger">*</span></label>
                    <select name="tipo_intervencion_edit" class="form-select" data-required="true">
                      <option value="Consulta"        {% if p.tipo_intervencion == 'Consulta' %}selected{% endif %}>Consulta</option>
                      <option value="Cirugía"         {% if p.tipo_intervencion == 'Cirugía' %}selected{% endif %}>Cirugía</option>
                      <option value="Seguimiento"     {% if p.tipo_intervencion == 'Seguimiento' %}selected{% endif %}>Seguimiento</option>
                      <option value="Terapia"         {% if p.tipo_intervencion == 'Terapia' %}selected{% endif %}>Terapia</option>
                      <option value="Administrativa"  {% if p.tipo_intervencion == 'Administrativa' %}selected{% endif %}>Administrativa</option>
                    </select>
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Fecha <span class="text-danger">*</span></label>
                    <input type="date" name="fecha_edit" class="form-control"
                           value="{{ p.fecha }}" data-required="true">
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Rol <span class="text-danger">*</span></label>
                    <input type="text" name="rol_edit" class="form-control"
                           value="{{ p.rol }}" data-required="true">
                  </div>

                  <div class="mb-3">
                    <label class="form-label">ID Tratamiento <span class="text-danger">*</span></label>
                    <input type="number" name="id_tratamiento_edit" class="form-control"
                           value="{{ p.id_tratamiento }}" data-required="true">
                  </div>

                  <div class="mb-3">
                    <label class="form-label">ID Empleado <span class="text-danger">*</span></label>
                    <input type="number" name="id_empleado_edit" class="form-control"
                           value="{{ p.id_empleado }}" data-required="true">
                  </div>

                </div>

                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                  <button type="submit" class="btn btn-primary">Guardar cambios</button>
                </div>

              </form>

            </div>
          </div>
        </div>

        <!-- MODAL ELIMINAR -->
        <div class="modal fade" id="modalEliminar{{ p.id_participacion }}" tabindex="-1"
             aria-labelledby="modalEliminarLabel{{ p.id_participacion }}" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">

              <form method="POST" action="{{ url_for('gestion_participaciones') }}">
                <input type="hidden" name="delete_participacion" value="1">
                <input type="hidden" name="id_participacion_eliminar" value="{{ p.id_participacion }}">

                <div class="modal-header">
                  <h5 class="modal-title">Confirmar eliminación</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                  ¿Seguro que deseas eliminar la participación ID 
                  <strong>{{ p.id_participacion }}</strong> ({{ p.tipo_intervencion }})?
                </div>

                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                  <button type="submit" class="btn btn-danger">Eliminar</button>
                </div>

              </form>

            </div>
          </div>
        </div>

        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- VALIDACIÓN JS -->
<script>
const formsParticipaciones = document.querySelectorAll("#formCrearParticipacion, form.formEditarParticipacion");

formsParticipaciones.forEach(form => {
  form.addEventListener("submit", function(e) {
    let valido = true;
    const obligatorios = form.querySelectorAll("[data-required='true']");
    const errorMsg = document.getElementById("errorCamposObligatorios");

    errorMsg.classList.add("d-none");

    obligatorios.forEach(campo => {
      campo.classList.remove("is-invalid");
      if (!campo.value || !campo.value.trim()) {
        valido = false;
        campo.classList.add("is-invalid");
      }
    });

    if (!valido) {
      e.preventDefault();
      errorMsg.classList.remove("d-none");
    }
  });
});
</script>

{% endblock %}

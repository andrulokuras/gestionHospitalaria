{% extends "base.html" %}

{% block title %}Gestión de Usuarios{% endblock %}

{% block content %}

<h2 class="mb-4">Gestión de Usuarios y Roles</h2>

<div class="alert alert-info">
  Esta sección solo está disponible para el usuario con rol <strong>admin</strong>.
</div>

<!-- MENSAJE DE ERROR GENÉRICO PARA CAMPOS OBLIGATORIOS (opcional) -->
<div id="errorCamposObligatorios" class="alert alert-danger d-none">
  Por favor llena todos los campos obligatorios marcados con
  (<span class="text-danger">*</span>).
</div>

<!-- ============================= -->
<!-- FORMULARIO: CREAR USUARIO    -->
<!-- ============================= -->
<div class="card mb-4 shadow-sm">
  <div class="card-header bg-primary text-white">
    Crear nuevo usuario
  </div>
  <div class="card-body">
    <form method="post" action="{{ url_for('gestion_usuarios') }}" id="formCrearUsuario" novalidate>
      <input type="hidden" name="create_usuario" value="1">

      <div class="row g-3">
        <!-- Username -->
        <div class="col-md-3">
          <label class="form-label">
            Usuario <span class="text-danger">*</span>
          </label>
          <input type="text" name="username" class="form-control" data-required="true">
        </div>

        <!-- Password -->
        <div class="col-md-3">
          <label class="form-label">
            Contraseña <span class="text-danger">*</span>
          </label>
          <input type="password" name="password" class="form-control" data-required="true">
        </div>

        <!-- Rol -->
        <div class="col-md-3">
          <label class="form-label">
            Rol <span class="text-danger">*</span>
          </label>
          <select name="rol" class="form-select" data-required="true">
            <option value="" disabled selected>Selecciona rol</option>
            <option value="admin">admin</option>
            <option value="medico">medico</option>
            <option value="enfermera">enfermera</option>
            <option value="administrativo">administrativo</option>
          </select>
        </div>

        <!-- Empleado asociado (opcional) -->
        <div class="col-md-3">
          <label class="form-label">
            Empleado (opcional)
          </label>
          <input
            list="listaEmpleadosUsuario"
            name="id_empleado"
            class="form-control"
            placeholder="Sin empleado o ej: 3 - Juan Pérez">
        </div>

      <div class="mt-3">
        <button type="submit" class="btn btn-success">
          <i class="bi bi-person-plus"></i> Crear usuario
        </button>
      </div>
    </form>
  </div>
</div>

<!-- ============================= -->
<!-- FILTROS DE BÚSQUEDA          -->
<!-- ============================= -->
<div class="card mb-3">
  <div class="card-body">
    <form method="get" action="{{ url_for('gestion_usuarios') }}" class="row g-2">
      <div class="col-md-4">
        <label class="form-label">Buscar por usuario</label>
        <input type="text" name="buscar_username" class="form-control"
               value="{{ filtro_username or '' }}" placeholder="ej. admin">
      </div>
      <div class="col-md-4">
        <label class="form-label">Filtrar por rol</label>
        <select name="buscar_rol" class="form-select">
          <option value="">Todos</option>
          <option value="admin"        {% if filtro_rol == 'admin' %}selected{% endif %}>admin</option>
          <option value="medico"       {% if filtro_rol == 'medico' %}selected{% endif %}>medico</option>
          <option value="enfermera"    {% if filtro_rol == 'enfermera' %}selected{% endif %}>enfermera</option>
          <option value="administrativo" {% if filtro_rol == 'administrativo' %}selected{% endif %}>administrativo</option>
        </select>
      </div>
      <div class="col-md-4 d-flex align-items-end">
        <button type="submit" class="btn btn-outline-primary me-2">
          <i class="bi bi-search"></i> Filtrar
        </button>
        <a href="{{ url_for('gestion_usuarios') }}" class="btn btn-outline-secondary">
          Limpiar
        </a>
      </div>
    </form>
  </div>
</div>

<!-- ============================= -->
<!-- TABLA DE USUARIOS            -->
<!-- ============================= -->
<div class="card">
  <div class="card-header">
    Usuarios registrados
  </div>
  <div class="card-body table-responsive">
    <table class="table table-striped table-hover align-middle">
      <thead>
        <tr>
          <th>ID</th>
          <th>Usuario</th>
          <th>Rol</th>
          <th>Empleado asociado</th>
          <th style="width: 220px;">Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% if usuarios %}
          {% for u in usuarios %}
            <tr>
              <td>{{ u.id_usuario }}</td>
              <td>{{ u.username }}</td>
              <td>{{ u.rol }}</td>
              <td>
                {% if u.id_empleado %}
                  {{ u.id_empleado }} - {{ u.nombre_empleado or 'Sin nombre' }}
                {% else %}
                  <span class="text-muted">Sin empleado asociado</span>
                {% endif %}
              </td>
              <td>
                <!-- Form de edición en línea -->
                <form method="post" class="d-inline-block" action="{{ url_for('gestion_usuarios') }}">
                  <input type="hidden" name="update_usuario" value="1">
                  <input type="hidden" name="id_usuario_actualizar" value="{{ u.id_usuario }}">

                  <div class="input-group input-group-sm mb-1">
                    <input type="text" name="username_edit" class="form-control"
                           placeholder="Usuario" value="{{ u.username }}">
                    <input type="text" name="password_edit" class="form-control"
                           placeholder="Nueva contraseña">
                  </div>

                  <div class="input-group input-group-sm mb-1">
                    <select name="rol_edit" class="form-select">
                      <option value="admin"        {% if u.rol == 'admin' %}selected{% endif %}>admin</option>
                      <option value="medico"       {% if u.rol == 'medico' %}selected{% endif %}>medico</option>
                      <option value="enfermera"    {% if u.rol == 'enfermera' %}selected{% endif %}>enfermera</option>
                      <option value="administrativo" {% if u.rol == 'administrativo' %}selected{% endif %}>administrativo</option>
                    </select>

                    <input
                      list="listaEmpleadosUsuario"
                      name="id_empleado_edit"
                      class="form-control"
                      placeholder="Sin empleado o ej: 3 - Juan Pérez"
                      value="{% if u.id_empleado %}{{ u.id_empleado }} - {{ u.nombre_empleado or 'Sin nombre' }}{% endif %}">

                  </div>

                  <button type="submit" class="btn btn-sm btn-warning">
                    Guardar cambios
                  </button>
                </form>

                <!-- Form de eliminación -->
                <form method="post" class="d-inline-block ms-1"
                      action="{{ url_for('gestion_usuarios') }}"
                      onsubmit="return confirm('¿Seguro que deseas eliminar este usuario?');">
                  <input type="hidden" name="delete_usuario" value="1">
                  <input type="hidden" name="id_usuario_eliminar" value="{{ u.id_usuario }}">
                  <button type="submit" class="btn btn-sm btn-danger">
                    Eliminar
                  </button>
                </form>
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="5" class="text-center text-muted">
              No hay usuarios registrados con los filtros actuales.
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>
<datalist id="listaEmpleadosUsuario">
  {% for e in empleados %}
    <option value="{{ e.id_empleado }} - {{ e.nombre }}"></option>
  {% endfor %}
</datalist>

{% endblock %}

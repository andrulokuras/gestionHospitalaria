{% extends "base.html" %}

{% block title %}Gestión de Citas Médicas{% endblock %}

{% block content %}
<h2 class="mb-4">Programación y Gestión de Citas</h2>

<div class="card mb-4">
  <div class="card-header bg-primary text-white">
    Agendar Nueva Cita
  </div>
  <div class="card-body">
    <form method="POST" action="{{ url_for('gestion_citas') }}">
      <input type="hidden" name="create_cita" value="1">
      <div class="row g-3">
        
        <div class="col-md-3">
          <label for="id_paciente" class="form-label">ID Paciente</label>
          <input type="number" id="id_paciente" name="id_paciente" class="form-control" required placeholder="Ej: 2">
        </div>

        <div class="col-md-3">
          <label for="id_empleado" class="form-label">ID Médico</label>
          <input type="number" id="id_empleado" name="id_empleado" class="form-control" required placeholder="Ej: 3">
        </div>

        <div class="col-md-3">
            <label for="id_area_especifica" class="form-label">ID Área (Consultorio)</label>
            <input type="number" id="id_area_especifica" name="id_area_especifica" class="form-control" placeholder="Opcional">
        </div>

        <div class="col-md-3">
            <label for="estado" class="form-label">Estado</label>
            <select id="estado" name="estado" class="form-select">
              <option value="Solicitada" selected>Solicitada</option>
              <option value="Confirmada">Confirmada</option>
              <option value="Cancelada">Cancelada</option>
              <option value="Completada">Completada</option>
              <option value="Ausente">Ausente</option>
            </select>
        </div>

        <div class="col-md-4">
          <label for="fecha_hora_inicio" class="form-label">Fecha y Hora</label>
          <input type="datetime-local" id="fecha_hora_inicio" name="fecha_hora_inicio" class="form-control" required>
        </div>

        <div class="col-md-2">
            <label for="duracion_minutos" class="form-label">Duración (min)</label>
            <input type="number" id="duracion_minutos" name="duracion_minutos" class="form-control" value="30">
        </div>

        <div class="col-md-6">
          <label for="motivo_consulta" class="form-label">Motivo de Consulta</label>
          <input type="text" id="motivo_consulta" name="motivo_consulta" class="form-control" placeholder="Ej: Dolor de cabeza intenso">
        </div>

        <div class="col-12 d-grid">
          <button type="submit" class="btn btn-success">Agendar Cita</button>
        </div>
      </div>
    </form>
  </div>
</div>

<div class="card">
  <div class="card-header">
    Calendario de Citas
  </div>
  <div class="card-body table-responsive">
    <table class="table table-striped table-hover align-middle">
      <thead>
        <tr>
          <th>ID</th>
          <th>Fecha/Hora</th>
          <th>Paciente</th>
          <th>Médico</th>
          <th>Área</th>
          <th>Motivo</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for c in citas %}
        <tr>
          <td>{{ c.id_cita }}</td>
          <td>{{ c.fecha_hora_inicio }}</td>
          <td>
            <span class="fw-bold">{{ c.nombre_paciente }}</span><br>
            <small class="text-muted">ID: {{ c.id_paciente }}</small>
          </td>
          <td>
            {{ c.nombre_medico }}<br>
            <small class="text-muted">ID: {{ c.id_empleado }}</small>
          </td>
          <td>
             {% if c.nombre_area %}{{ c.nombre_area }}{% else %}-{% endif %}
          </td>
          <td>{{ c.motivo_consulta }}</td>
          <td>
            {% if c.estado == 'Confirmada' %}
                <span class="badge bg-primary">{{ c.estado }}</span>
            {% elif c.estado == 'Completada' %}
                <span class="badge bg-success">{{ c.estado }}</span>
            {% elif c.estado == 'Cancelada' %}
                <span class="badge bg-danger">{{ c.estado }}</span>
            {% else %}
                <span class="badge bg-secondary">{{ c.estado }}</span>
            {% endif %}
          </td>
          <td>
            <button class="btn btn-sm btn-warning" data-bs-toggle="modal"
                    data-bs-target="#modalEditar{{ c.id_cita }}">
              <i class="bi bi-pencil"></i> Editar
            </button>
            <button class="btn btn-sm btn-danger" data-bs-toggle="modal"
                    data-bs-target="#modalEliminar{{ c.id_cita }}">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>

        <div class="modal fade" id="modalEditar{{ c.id_cita }}" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <form method="POST" action="{{ url_for('gestion_citas') }}">
                <input type="hidden" name="update_cita" value="1">
                <input type="hidden" name="id_cita_actualizar" value="{{ c.id_cita }}">
                <div class="modal-header">
                  <h5 class="modal-title">Editar Cita #{{ c.id_cita }}</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <div class="row g-3">
                      <div class="col-md-6">
                        <label class="form-label">ID Paciente</label>
                        <input type="number" name="id_paciente_edit" class="form-control" value="{{ c.id_paciente }}" required>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">ID Médico</label>
                        <input type="number" name="id_empleado_edit" class="form-control" value="{{ c.id_empleado }}" required>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Fecha y Hora</label>
                        <input type="datetime-local" name="fecha_hora_inicio_edit" class="form-control" value="{{ c.fecha_hora_inicio }}" required>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Duración (min)</label>
                        <input type="number" name="duracion_minutos_edit" class="form-control" value="{{ c.duracion_minutos }}">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Área</label>
                        <input type="number" name="id_area_especifica_edit" class="form-control" value="{{ c.id_area_especifica }}">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Estado</label>
                        <select name="estado_edit" class="form-select">
                          <option value="Solicitada" {% if c.estado == 'Solicitada' %}selected{% endif %}>Solicitada</option>
                          <option value="Confirmada" {% if c.estado == 'Confirmada' %}selected{% endif %}>Confirmada</option>
                          <option value="Cancelada" {% if c.estado == 'Cancelada' %}selected{% endif %}>Cancelada</option>
                          <option value="Completada" {% if c.estado == 'Completada' %}selected{% endif %}>Completada</option>
                          <option value="Ausente" {% if c.estado == 'Ausente' %}selected{% endif %}>Ausente</option>
                        </select>
                      </div>
                      <div class="col-12">
                        <label class="form-label">Motivo</label>
                        <input type="text" name="motivo_consulta_edit" class="form-control" value="{{ c.motivo_consulta }}">
                      </div>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                  <button type="submit" class="btn btn-primary">Guardar cambios</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <div class="modal fade" id="modalEliminar{{ c.id_cita }}" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <form method="POST" action="{{ url_for('gestion_citas') }}">
                <input type="hidden" name="delete_cita" value="1">
                <input type="hidden" name="id_cita_eliminar" value="{{ c.id_cita }}">
                <div class="modal-header">
                  <h5 class="modal-title">Confirmar cancelación</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  ¿Seguro que deseas eliminar la cita de <strong>{{ c.nombre_paciente }}</strong> programada para el {{ c.fecha_hora_inicio }}?
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No, regresar</button>
                  <button type="submit" class="btn btn-danger">Sí, eliminar</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
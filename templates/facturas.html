{% extends "base.html" %}

{% block title %}Facturas{% endblock %}

{% block content %}

<div class="row mb-4">
    <div class="col">
        <h1 class="h3">Gestión de Facturación Hospitalaria</h1>
        <p class="text-muted">
            Control de facturas y pagos registrados por paciente.
        </p>
    </div>
</div>

<!-- ============================= -->
<!-- FORMULARIO: CREAR FACTURA    -->
<!-- ============================= -->
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white">
        Crear nueva factura
    </div>
    <div class="card-body">
        <form method="post" action="{{ url_for('gestion_facturas') }}">
            <input type="hidden" name="create_factura" value="1">

            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="id_paciente" class="form-label">ID Paciente</label>
                    <input type="number" min="1" class="form-control" id="id_paciente"
                           name="id_paciente" placeholder="Ej: 1" required>
                </div>

                <div class="col-md-3">
                    <label for="fecha_emision" class="form-label">Fecha de emisión</label>
                    <input type="date" class="form-control" id="fecha_emision"
                           name="fecha_emision" required>
                </div>

                <div class="col-md-3">
                    <label for="fecha_vencimiento" class="form-label">Fecha de vencimiento</label>
                    <input type="date" class="form-control" id="fecha_vencimiento"
                           name="fecha_vencimiento">
                </div>

                <div class="col-md-3">
                    <label for="estado" class="form-label">Estado</label>
                    <select class="form-select" id="estado" name="estado">
                        <option value="Pendiente" selected>Pendiente</option>
                        <option value="Pagada">Pagada</option>
                        <option value="Parcial">Parcial</option>
                        <option value="Cancelada">Cancelada</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label for="metodo_pago_preferido" class="form-label">
                        Método pago preferido
                    </label>
                    <select class="form-select" id="metodo_pago_preferido"
                            name="metodo_pago_preferido">
                        <option value="" selected>-- Ninguno --</option>
                        <option value="Efectivo">Efectivo</option>
                        <option value="Tarjeta">Tarjeta</option>
                        <option value="Transferencia">Transferencia</option>
                        <option value="Seguro">Seguro</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label for="total_neto" class="form-label">Total neto de la factura ($)</label>
                    <input type="number" step="0.01" min="0" class="form-control"
                           id="total_neto" name="total_neto" placeholder="Ej: 1500.00" required>
                </div>

                <div class="col-12">
                    <label for="observaciones" class="form-label">Observaciones</label>
                    <textarea class="form-control" id="observaciones"
                              name="observaciones" rows="2"
                              placeholder="Notas adicionales de la factura (opcional)"></textarea>
                </div>

                <div class="col-12 text-end">
                    <button type="submit" class="btn btn-primary">
                        Crear factura
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- ============================= -->
<!-- LISTA DE FACTURAS            -->
<!-- ============================= -->

<h2 class="h4 mb-3">Facturas registradas</h2>

{% if not facturas %}
    <div class="alert alert-info">
        No hay facturas registradas aún.
    </div>
{% else %}

<div class="accordion" id="accordionFacturas">
    {% for f in facturas %}
        {# Obtenemos los pagos de esta factura #}
        {% set pagos = pagos_por_factura.get(f.id_factura, []) %}

        {# Namespace para poder acumular dentro del for #}
        {% set ns = namespace(total_pagado=0) %}
        {% for p in pagos %}
            {% set ns.total_pagado = ns.total_pagado + (p.monto or 0) %}
        {% endfor %}

        {% set total_pagado = ns.total_pagado %}
        {% set saldo_pendiente = (f.total_neto or 0) - total_pagado %}


        <div class="accordion-item mb-2">
            <h2 class="accordion-header" id="heading{{ f.id_factura }}">
                <button class="accordion-button collapsed" type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#collapse{{ f.id_factura }}"
                        aria-expanded="false"
                        aria-controls="collapse{{ f.id_factura }}">
                    Factura #{{ f.id_factura }} —
                    Paciente {{ f.id_paciente }} —
                    Estado: {{ f.estado }} —
                    Total: ${{ '%.2f'|format(f.total_neto) }} —
                    Pagado: ${{ '%.2f'|format(total_pagado) }} —
                    Saldo: ${{ '%.2f'|format(saldo_pendiente) }}
                </button>
            </h2>
            <div id="collapse{{ f.id_factura }}"
                 class="accordion-collapse collapse"
                 aria-labelledby="heading{{ f.id_factura }}"
                 data-bs-parent="#accordionFacturas">
                <div class="accordion-body">

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <p class="mb-1"><strong>Fecha emisión:</strong> {{ f.fecha_emision }}</p>
                            <p class="mb-1"><strong>Fecha vencimiento:</strong> {{ f.fecha_vencimiento or '—' }}</p>
                        </div>
                        <div class="col-md-4">
                            <p class="mb-1"><strong>Método preferido:</strong> {{ f.metodo_pago_preferido or '—' }}</p>
                        </div>
                        <div class="col-md-4">
                            <p class="mb-1"><strong>Observaciones:</strong></p>
                            <p class="small text-muted">{{ f.observaciones or 'Sin observaciones.' }}</p>
                        </div>
                    </div>

                    <hr>

                    <h5 class="h6">Pagos registrados</h5>

                    {% if not pagos %}
                        <p class="text-muted">Aún no hay pagos registrados para esta factura.</p>
                    {% else %}
                        <div class="table-responsive mb-2">
                            <table class="table table-sm table-striped align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID Pago</th>
                                        <th>Fecha</th>
                                        <th>Monto</th>
                                        <th>Método</th>
                                        <th>Referencia</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for p in pagos %}
                                    <tr>
                                        <td>{{ p.id_pago }}</td>
                                        <td>{{ p.fecha_pago }}</td>
                                        <td>${{ '%.2f'|format(p.monto) }}</td>
                                        <td>{{ p.metodo_pago }}</td>
                                        <td>{{ p.referencia or '—' }}</td>
                                        <td>
                                            <form method="post" action="{{ url_for('gestion_facturas') }}"
                                                  onsubmit="return confirm('¿Eliminar este pago?');">
                                                <input type="hidden" name="delete_pago" value="1">
                                                <input type="hidden" name="id_pago_eliminar" value="{{ p.id_pago }}">
                                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                                    Eliminar
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% endif %}

                    <div class="mt-3 d-flex justify-content-between align-items-center">
                        <button class="btn btn-sm btn-success"
                                data-bs-toggle="modal"
                                data-bs-target="#modalPago{{ f.id_factura }}">
                            Registrar pago
                        </button>

                        <form method="post" action="{{ url_for('gestion_facturas') }}"
                              onsubmit="return confirm('¿Eliminar esta factura y sus pagos asociados?');">
                            <input type="hidden" name="delete_factura" value="1">
                            <input type="hidden" name="id_factura_eliminar" value="{{ f.id_factura }}">
                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                Eliminar factura
                            </button>
                        </form>
                    </div>

                </div>
            </div>
        </div>
    {% endfor %}
</div>

{% endif %}

<!-- ============================= -->
<!-- MODALES PARA REGISTRAR PAGOS -->
<!-- ============================= -->
{% for f in facturas %}
<div class="modal fade" id="modalPago{{ f.id_factura }}" tabindex="-1"
     aria-labelledby="modalPagoLabel{{ f.id_factura }}" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="{{ url_for('gestion_facturas') }}">
        <input type="hidden" name="create_pago" value="1">
        <input type="hidden" name="id_factura_pago" value="{{ f.id_factura }}">

        <div class="modal-header">
          <h5 class="modal-title" id="modalPagoLabel{{ f.id_factura }}">
            Registrar pago para factura #{{ f.id_factura }}
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"
                  aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Fecha de pago</label>
            <input type="date" class="form-control" name="fecha_pago" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Monto ($)</label>
            <input type="number" step="0.01" min="0" class="form-control"
                   name="monto_pago" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Método de pago</label>
            <select class="form-select" name="metodo_pago" required>
              <option value="Efectivo">Efectivo</option>
              <option value="Tarjeta">Tarjeta</option>
              <option value="Transferencia">Transferencia</option>
              <option value="Seguro">Seguro</option>
              <option value="Otro">Otro</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Referencia (opcional)</label>
            <input type="text" class="form-control" name="referencia_pago"
                   placeholder="Folio, número de operación, etc.">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary"
                  data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">
            Guardar pago
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endfor %}

{% endblock %}
